name: Core Tests

on: 
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-core:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: [3.11]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        cd src/xoneai
        # Core extras only ‚Äî heavy framework extras (crewai, autogen, gradio, etc.)
        # are tested in the extended/framework-specific workflows
        uv pip install --system ".[ui,api,openai,chat,code]"
        uv pip install --system duckduckgo_search
        uv pip install --system pytest pytest-asyncio pytest-cov pytest-timeout
        # Install knowledge dependencies from xoneai-agents
        uv pip install --system "xoneaiagents[knowledge]"

    - name: Set environment variables
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY || 'sk-test-key-for-github-actions-testing-only-not-real' }}" >> $GITHUB_ENV
        echo "OPENAI_API_BASE=${{ secrets.OPENAI_API_BASE || 'https://api.openai.com/v1' }}" >> $GITHUB_ENV
        echo "OPENAI_MODEL_NAME=${{ secrets.OPENAI_MODEL_NAME || 'gpt-4o-mini' }}" >> $GITHUB_ENV
        echo "LOGLEVEL=WARNING" >> $GITHUB_ENV
        echo "PYTHONPATH=${{ github.workspace }}/src/xoneai-agents:$PYTHONPATH" >> $GITHUB_ENV

    - name: Run Unit Tests
      run: |
        cd src/xoneai && python -m pytest tests/unit/ \
          -v --tb=short --disable-warnings \
          --cov=xoneai --cov-report=term-missing --cov-report=xml --cov-branch \
          || echo "Some unit tests failed - see output above"
      continue-on-error: true

    - name: Run Integration Tests
      run: |
        cd src/xoneai && python -m pytest tests/integration/ \
          -v --tb=short --disable-warnings \
          --ignore=tests/integration/test_ollama_tool_calling_live.py \
          --ignore=tests/integration/test_rag_live.py \
          --ignore=tests/integration/test_model_routing_real.py \
          --ignore=tests/integration/test_real_key_smoke.py \
          -m "not real" \
          || echo "Some integration tests failed - see output above"
      continue-on-error: true

    - name: Test AutoGen Framework
      run: |
        echo "ü§ñ Testing AutoGen Framework Integration..."
        cd src/xoneai && python -m pytest tests/integration/autogen/ \
          -v --tb=short --disable-warnings \
          || echo "AutoGen tests failed or skipped"
      continue-on-error: true

    - name: Test CrewAI Framework
      run: |
        echo "‚õµ Testing CrewAI Framework Integration..."
        cd src/xoneai && python -m pytest tests/integration/crewai/ \
          -v --tb=short --disable-warnings \
          || echo "CrewAI tests failed or skipped"
      continue-on-error: true

    - name: Run Legacy Tests
      # Skips automatically when only the fallback key is present
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test-key-for-github-actions-testing-only-not-real' }}
        OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE || 'https://api.openai.com/v1' }}
        OPENAI_MODEL_NAME: ${{ secrets.OPENAI_MODEL_NAME || 'gpt-4o-mini' }}
        LOGLEVEL: WARNING
      run: |
        if [ "$OPENAI_API_KEY" = 'sk-test-key-for-github-actions-testing-only-not-real' ]; then
          echo "‚è≠Ô∏è Skipping legacy tests ‚Äî no real API key configured"
          exit 0
        fi
        echo "üß™ Running legacy tests with real API key..."
        cd src/xoneai && python -m pytest tests/test.py \
          -v --tb=short --disable-warnings \
          -m "not real"
      continue-on-error: true

    - name: Upload coverage reports to Codecov
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: src/xoneai/coverage.xml
        flags: core-tests
        name: core-tests-coverage
        fail_ci_if_error: false
        verbose: true

    - name: Upload Coverage Reports (Artifacts)
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          src/xoneai/.coverage
          src/xoneai/htmlcov/
          src/xoneai/coverage.xml
        retention-days: 7